services:
  traefik:
    image: traefik:v3.6.1  # Use the latest stable version
    container_name: traefik
    command:
      - --api.dashboard=true
      - --api.insecure=true  # This enables direct access on port 8080
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=voting-app-ha_default
      - --entrypoints.web.address=:80
    ports:
      - "80:80"
      - "8080:8080"  # Dashboard port
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - default
      - monitoring
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Dashboard routing - external access
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard.middlewares=auth"
      # Basic auth middleware (optional but recommended)
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$9Cv/OMGj$$ZomWQzuQbL.3TRCS81A1g/" # password: admin

  # PostgreSQL HA Cluster
  postgres-primary:
    image: postgres:16-alpine
    container_name: postgres-primary
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: trust
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c listen_addresses='*'
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./postgres-init/primary-init.sh:/docker-entrypoint-initdb.d/primary-init.sh
      - ./postgres-init/fix-schema.sql:/docker-entrypoint-initdb.d/fix-schema.sql:ro        
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-replica1:
    image: postgres:16-alpine
    container_name: postgres-replica1
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INSTANCE: replica1
    volumes:
      - postgres-replica1-data:/var/lib/postgresql/data
      - ./postgres-init/replica-reliable.sh:/docker-entrypoint-initdb.d/replica-reliable.sh:ro
      - ./postgres-init/replica-startup-proper.sh:/replica-startup.sh:ro
    command: ["/replica-startup.sh"]
    ports:
      - "5434:5432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres && psql -U postgres -c 'SELECT pg_is_in_recovery();' | grep -q 't'"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  postgres-replica2:
    image: postgres:16-alpine
    container_name: postgres-replica2
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INSTANCE: replica2
    volumes:
      - postgres-replica2-data:/var/lib/postgresql/data
      - ./postgres-init/replica-reliable.sh:/docker-entrypoint-initdb.d/replica-reliable.sh:ro
      - ./postgres-init/replica-startup-proper.sh:/replica-startup.sh:ro
    command: ["/replica-startup.sh"]
    ports:
      - "5435:5432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres && psql -U postgres -c 'SELECT pg_is_in_recovery();' | grep -q 't'"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # PgPool-II for Load Balancing + Connection Pooling + Auto-Failover

  pgpool:
    image: pgpool/pgpool:latest
    container_name: pgpool
    ports:
      - "5432:5432"
    environment:
      # Backend configuration
      PGPOOL_PARAMS_BACKEND_HOSTNAME0: "postgres-primary"
      PGPOOL_PARAMS_BACKEND_HOSTNAME1: "postgres-replica1"
      PGPOOL_PARAMS_BACKEND_HOSTNAME2: "postgres-replica2"
      PGPOOL_PARAMS_BACKEND_PORT0: "5432"
      PGPOOL_PARAMS_BACKEND_PORT1: "5432"
      PGPOOL_PARAMS_BACKEND_PORT2: "5432"
      PGPOOL_PARAMS_BACKEND_WEIGHT0: "1"
      PGPOOL_PARAMS_BACKEND_WEIGHT1: "1"
      PGPOOL_PARAMS_BACKEND_WEIGHT2: "1"
      PGPOOL_PARAMS_BACKEND_DATA_DIRECTORY0: "/var/lib/postgresql/data"
      PGPOOL_PARAMS_BACKEND_DATA_DIRECTORY1: "/var/lib/postgresql/data"
      PGPOOL_PARAMS_BACKEND_DATA_DIRECTORY2: "/var/lib/postgresql/data"
      PGPOOL_PARAMS_BACKEND_FLAG0: "ALWAYS_PRIMARY"
      PGPOOL_PARAMS_BACKEND_FLAG1: "DISALLOW_TO_FAILOVER"
      PGPOOL_PARAMS_BACKEND_FLAG2: "DISALLOW_TO_FAILOVER"
      # Basic settings
      PGPOOL_PARAMS_NUM_INIT_CHILDREN: "100"
      PGPOOL_PARAMS_MAX_POOL: "4"
      PGPOOL_PARAMS_PORT: "5432"
      PGPOOL_PARAMS_LISTEN_ADDRESSES: "*"
      # Load balancing
      PGPOOL_PARAMS_ENABLE_LOAD_BALANCING: "on"
      PGPOOL_PARAMS_MASTER_SLAVE_MODE: "on"
      # Health checks
      PGPOOL_PARAMS_HEALTH_CHECK_PERIOD: "10"
      PGPOOL_PARAMS_HEALTH_CHECK_USER: "postgres"
      PGPOOL_PARAMS_HEALTH_CHECK_PASSWORD: "postgres"
      PGPOOL_PARAMS_HEALTH_CHECK_TIMEOUT: "20"
      # Failover (disabled for stability)
      PGPOOL_PARAMS_FAILOVER_ON_BACKEND_ERROR: "off"        
    depends_on:
      - postgres-primary
      - postgres-replica1
      - postgres-replica2
    networks:
      default:
        aliases:
          - db
    restart: unless-stopped      

  pg-backup:
    image: postgres:16-alpine
    container_name: pg-backup
    restart: unless-stopped
    volumes:
      - pg-backup-data:/backups
      - ./backup/simple-pg-backup.sh:/backup/simple-pg-backup.sh:ro
      - ./backup/backup-cron:/etc/cron.d/backup-cron:ro
    command: >
      sh -c "apk add --no-cache gzip jq dcron &&
             chmod +x /backup/simple-pg-backup.sh &&
             crontab /etc/cron.d/backup-cron &&
             crond && tail -f /backup/backup.log"
    depends_on:
      - postgres-primary
      - postgres-replica1
      - postgres-replica2


  # Redis

  redis-a:
    image: redis:7-alpine
    container_name: redis-a
    command: redis-server --appendonly yes --port 6379
    volumes:
      - redis-data-a:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - redis-network
      - monitoring

  redis-b:
    image: redis:7-alpine
    container_name: redis-b
    command: redis-server --appendonly yes --port 6379 --replicaof redis-a 6379
    volumes:
      - redis-data-b:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    depends_on:
      - redis-a
    networks:
      - redis-network
      - monitoring

  redis-c:
    image: redis:7-alpine
    container_name: redis-c
    command: redis-server --appendonly yes --port 6379 --replicaof redis-a 6379
    volumes:
      - redis-data-c:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    depends_on:
      - redis-a
    networks:
      - redis-network
      - monitoring

  redis-sentinel1:
    image: redis:7-alpine
    container_name: redis-sentinel1
    volumes:
      - ./redis/sentinel-init.sh:/sentinel-init.sh
    command: ["sh", "/sentinel-init.sh"]
    ports:
      - "26379:26379"
    depends_on:
      - redis-a
    networks:
      - redis-network
      - monitoring        

  redis-sentinel2:
    image: redis:7-alpine
    container_name: redis-sentinel2
    volumes:
      - ./redis/sentinel-init.sh:/sentinel-init.sh
    command: ["sh", "/sentinel-init.sh"]
    depends_on:
      - redis-a
    networks:
      - redis-network
      - monitoring

  redis-sentinel3:
    image: redis:7-alpine
    container_name: redis-sentinel3
    volumes:
      - ./redis/sentinel-init.sh:/sentinel-init.sh
    command: ["sh", "/sentinel-init.sh"]
    depends_on:
      - redis-a
    networks:
      - monitoring
      - redis-network

  redis-proxy:
    image: haproxy:2.9-alpine
    container_name: redis-proxy
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./redis/haproxy/redis-haproxy-fixed.cfg:/usr/local/etc/haproxy/haproxy.cfg:rw
    depends_on:
      - redis-a
      - redis-b
      - redis-c
      - redis-sentinel1
      - redis-sentinel2
      - redis-sentinel3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
    networks:
      monitoring:
      redis-network:
        aliases:
          - redis
      
  # Voting App

  vote:
    build: ./voting-app/vote
    container_name: voting-app-vote
    ports:
      - "50000:80"
    depends_on:
      pgpool:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - default
      - redis-network  
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vote.rule=Host(`vote.localhost`)"
      - "traefik.http.routers.vote.entrypoints=web"
      - "traefik.http.services.vote.loadbalancer.server.port=80"        

  result:
    build: ./voting-app/result
    container_name: voting-app-result
    ports:
      - "50010:80"
    depends_on:
      pgpool:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - default
      - redis-network        
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.result.rule=Host(`result.localhost`)"
      - "traefik.http.routers.result.entrypoints=web"
      - "traefik.http.services.result.loadbalancer.server.port=80"

  worker:
    build: ./voting-app/worker
    container_name: voting-app-worker
    depends_on:
      pgpool:
        condition: service_started
    restart: unless-stopped
    networks:
      - default
      - redis-network

  # WordPress
  wordpress-db:
    image: mysql:8.0
    container_name: wordpress-db
    environment:
      MYSQL_ROOT_PASSWORD: wordpress123
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress123
    volumes:
      - wordpress-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  wordpress:
    image: wordpress:6.5
    container_name: wordpress-app
    environment:
      WORDPRESS_DB_HOST: wordpress-db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress123
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wordpress-data:/var/www/html
    ports:
      - "8083:80"
    depends_on:
      - wordpress-db
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wordpress.rule=Host(`wordpress.localhost`)"
      - "traefik.http.routers.wordpress.entrypoints=web"
      - "traefik.http.services.wordpress.loadbalancer.server.port=80"      


volumes:
  postgres-primary-data:
  postgres-replica1-data:
  postgres-replica2-data:
  pg-backup-data:  
  redis-data-a:
  redis-data-b:
  redis-data-c:    
  wordpress-db-data:
  wordpress-data:

networks:
  default:
    name: voting-app-ha_default
    external: false
  voting-app-network:
    external: true
    name: voting-app-network
  redis-network:
    external: false
  monitoring:
    external: true
    name: monitoring      
