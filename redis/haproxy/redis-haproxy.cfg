global
    daemon
    maxconn 10000

defaults
    mode tcp
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    option tcplog
    option tcp-check

frontend redis_frontend
    bind *:6379
    default_backend redis_master_backend

backend redis_master_backend
    # Health check that detects Redis role
    option tcp-check
    tcp-check send PING\r\n
    tcp-check expect string +PONG
    tcp-check send info\ replication\r\n
    tcp-check expect string role:master
    tcp-check send QUIT\r\n
    tcp-check expect string +OK

    # Redis servers
    server redis1 redis-a:6379 check inter 2s fall 3 rise 2
    server redis2 redis-b:6379 check inter 2s fall 3 rise 2
    server redis3 redis-c:6379 check inter 2s fall 3 rise 2

    # Only route to healthy master
    balance first
